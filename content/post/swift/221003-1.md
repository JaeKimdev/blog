---
title: "WWDC21 - ARC in Swift: Basics and beyond"
date: 2022-10-03T20:33:16+08:00

categories:
  - WWDC

tags:
  - swift
  - ARC

image: https://res.cloudinary.com/dwrejmale/image/upload/v1664800896/960x0_gtyc2h.png #the-creative-exchange-d2zvqp3fpro-unsplash.jpg
---

![img](post/swift/221003-1.png)

스위프트는 ARC(Automatic Reference Counting)를 사용하여 앱의 메모리 사용량을 관리하고 추적한다. Swift를 효율적으로 사용하기 위해서 ARC가 동작하는 방식을 이해 해보자.

## Object lifetimes and ARC

- `Object lifetime`은 `init()`에서 시작되고 마지막으로 사용되면 끝난다.
- ARC는 lifetime이 끝난 객체를 deallocate(할당 해제)한다.
- ARC는 참조 카운트(reference count)를 사용하여 객체의 lifetime을 추적한다.
- Swift 컴파일러가 `retain`과 `release`를 자동으로 삽입한다.
- reference count가 0이 되면 객체는 deallocate된다.

![img](post/swift/221003-2.png)

위의 예제코드에서 `Traveler`의 참조가 시작되고 끝나는 지점을 확인할 수 있다.
`traveler1`이 `Traveler`의 인스턴스를 생성하는 시점에 참조가 시작되고, `traveler2`가 `traveler1`을 참조하는 시점에 `traveler1`에 대한 사용이 종료되어 참조가 종료된다.

![img](post/swift/221003-3.png)

Swift 컴파일러는 init()되는 시점에 reference count가 1 올라가고(`retain` 생략),
`traveler1`에 대한 사용이 끝난 지점에 `release`를 자동으로 삽입해 준다.

그렇다면 `traveler2` 인스턴스에 대한 참조는 어떻게 될까?

![img](post/swift/221003-4.png)

`traveler2`가 `traveler1`을 참조하는 시점에 `traveler1`에 대한 참조가 시작되고, `traveler2`의 destination에 "Big Sur"를 할당하는 시점에 `traveler1`에 대한 참조가 종료된다.

![img](post/swift/221003-5.png)

Swift 컴파일러가 시작 전 `retain`을 삽입하고, `traveler2`의 마지막 사용(destination에 "Big Sur"를 할당)후에 `release`를 삽입해 준다.

**런타임에서 무슨 일이 일어나고 있는지 그림으로 다시 확인해 보자.**

![img](post/swift/221003-6.png)

`Traveler` 객체는 초기화되면서 `Heap`영역에 생성되고, reference count가 1로 증가한다.

![img](post/swift/221003-7.png)

`traveler1`을 `traveler2`에 할당하면서 `traveler1`의 reference count가 2로 증가한다.

![img](post/swift/221003-8.png)

`treveler1`의 사용이 완료되어 `release`가 호출되면서 reference count가 1로 감소한다.

![img](post/swift/221003-9.png)

`traveler2`의 `destination`에 "Big Sur"를 할당되어 계속해서 `treveler2`가 사용되고 있으므로 reference count는 1로 유지된다.

![img](post/swift/221003-10.png)

`traveler2`의 사용이 완료되어 `release`가 호출되면서 reference count가 0이 되고 메모리에서 해제된다.

## object lifetime in Swift

스위프트에서 객체의 lifetime은 사용기반(use-based)으로 결정된다. 객체의 lifetime은 초기화되는 시점부터 마지막 사용까지 보장된다.

![img](post/swift/221003-11.png)

실제 수명 주기는 컴파일러가 자동으로 삽입해주는 `retain`과 `release`에 의해 결정되므로, 최소한으로 보장된 수명주기와 달라질 수 있다. 대부분의 경우에서는 정확한 수명주기가 중요하지 않다.

## Observable object lifetimes

## Reference

[WWDC21 - ARC in Swift: Basics and beyond](https://developer.apple.com/videos/play/wwdc2021/10216/)  
[Swift Doc - Automatic Reference Counting
](https://docs.swift.org/swift-book/LanguageGuide/AutomaticReferenceCounting.html)
